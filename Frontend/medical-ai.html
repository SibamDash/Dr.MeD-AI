<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dr.MeD - Medical Report Intelligence</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1E3A8A;
            --primary-light: #3B82F6;
            --primary-dark: #1e40af;
            --secondary: #60A5FA;
            --accent: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-light: #F8FAFC;
            --bg-white: #FFFFFF;
            --bg-card: #FFFFFF;
            --bg-card-hover: #F1F5F9;
            --text-primary: #1E293B;
            --text-secondary: #64748B;
            --text-muted: #94A3B8;
            --border: #E2E8F0;
            --shadow: 0 10px 40px rgba(30, 58, 138, 0.1);
            --shadow-hover: 0 20px 60px rgba(30, 58, 138, 0.15);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-light);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Animated Background */
        .background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.3;
            background: 
                radial-gradient(circle at 20% 50%, rgba(30, 58, 138, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(96, 165, 250, 0.08) 0%, transparent 50%);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            position: relative;
            z-index: 1;
        }

        /* Header */
        header {
            padding: 2rem 0;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            animation: slideDown 0.6s ease-out;
            box-shadow: 0 2px 10px rgba(30, 58, 138, 0.05);
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--primary);
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            font-weight: bold;
            animation: pulse 2s infinite;
            box-shadow: 0 4px 15px rgba(30, 58, 138, 0.3);
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(30, 58, 138, 0.3);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 4px 20px rgba(30, 58, 138, 0.5);
            }
        }

        nav {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        nav a {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s;
            position: relative;
        }

        nav a::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--primary);
            transition: width 0.3s;
        }

        nav a:hover {
            color: var(--primary);
        }

        nav a:hover::after {
            width: 100%;
        }

        .user-profile {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s;
            color: white;
        }

        .user-profile:hover {
            transform: scale(1.1);
        }

        /* Hero Section */
        .hero {
            padding: 4rem 0;
            text-align: center;
            animation: fadeIn 0.8s ease-out 0.2s both;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hero h1 {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .hero p {
            font-size: 1.25rem;
            color: var(--text-secondary);
            max-width: 700px;
            margin: 0 auto 2rem;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 3rem;
            margin-top: 3rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            margin: 3rem 0;
            animation: fadeIn 0.8s ease-out 0.4s both;
        }

        /* Upload Section */
        .upload-section {
            background: var(--bg-white);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid var(--border);
            height: fit-content;
            max-height: calc(100vh - 150px);
            overflow-y: auto;
            position: sticky;
            top: 120px;
            box-shadow: var(--shadow);
        }
        
        /* Custom scrollbar for upload section */
        .upload-section::-webkit-scrollbar {
            width: 6px;
        }

        .upload-section::-webkit-scrollbar-track {
            background: transparent;
        }

        .upload-section::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        .upload-section::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .title-icon {
            width: 30px;
            height: 30px;
            background: var(--primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: white;
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 15px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(30, 58, 138, 0.03);
            position: relative;
            overflow: hidden;
        }

        .upload-area::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(30, 58, 138, 0.05), transparent);
            transform: rotate(45deg);
            transition: all 0.6s;
        }

        .upload-area:hover::before {
            left: 100%;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(30, 58, 138, 0.05);
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .patient-info {
            margin-top: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9rem;
        }

        input, select {
            width: 100%;
            padding: 0.875rem 1rem;
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }

        .analyze-btn {
            width: 100%;
            padding: 1rem;
            background: var(--primary);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 1.5rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(30, 58, 138, 0.3);
        }

        .analyze-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .analyze-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .analyze-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(30, 58, 138, 0.4);
            background: var(--primary-dark);
        }

        /* Results Section */
        .results-section {
            display: grid;
            gap: 2rem;
        }

        .card {
            background: var(--bg-white);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid var(--border);
            transition: all 0.3s;
            box-shadow: var(--shadow);
        }

        .card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-hover);
            transform: translateY(-5px);
        }

        /* AI Analysis Card */
        .ai-analysis {
            background: linear-gradient(135deg, rgba(30, 58, 138, 0.05), rgba(59, 130, 246, 0.05));
            position: relative;
            overflow: hidden;
        }

        .ai-analysis::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(30, 58, 138, 0.1), transparent);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translate(0, 0);
            }
            50% {
                transform: translate(-20px, -20px);
            }
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .confidence-badge {
            background: var(--accent);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .analysis-content {
            position: relative;
            z-index: 1;
        }

        .analysis-text {
            font-size: 1.1rem;
            line-height: 1.8;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .key-findings {
            display: grid;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .finding-item {
            background: var(--bg-light);
            padding: 1rem;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .finding-item:hover {
            background: var(--bg-card-hover);
            transform: translateX(5px);
            box-shadow: 0 2px 10px rgba(30, 58, 138, 0.1);
        }

        .finding-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .finding-value {
            font-family: 'JetBrains Mono', monospace;
            color: var(--primary);
            font-weight: 600;
        }

        .status-normal {
            color: var(--accent);
        }

        .status-warning {
            color: var(--warning);
        }

        .status-critical {
            color: var(--danger);
        }
        .status-low {
            color: var(--warning);
        }
        .status-high {
            color: var(--danger);
        }

        /* Medical Insights */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .insight-card {
            background: var(--bg-light);
            padding: 1.5rem;
            border-radius: 15px;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .insight-card:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(30, 58, 138, 0.1);
        }

        .insight-icon {
            width: 50px;
            height: 50px;
            background: var(--primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: white;
        }

        .insight-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .insight-description {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* Recommendations */
        .recommendations {
            display: grid;
            gap: 1rem;
        }

        .recommendation-item {
            background: rgba(16, 185, 129, 0.1);
            border-left: 4px solid var(--accent);
            padding: 1.5rem;
            border-radius: 12px;
            display: flex;
            gap: 1rem;
            transition: all 0.3s;
        }

        .recommendation-item:hover {
            background: rgba(16, 185, 129, 0.15);
            transform: translateX(5px);
        }

        .recommendation-icon {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .recommendation-content h4 {
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .recommendation-content p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* Uncertainty Indicators */
        .uncertainty-section {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid var(--warning);
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 1.5rem;
        }

        .uncertainty-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            color: var(--warning);
            font-weight: 600;
        }

        .uncertainty-list {
            list-style: none;
            padding-left: 1rem;
        }

        .uncertainty-list li {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            position: relative;
            padding-left: 1.5rem;
        }

        .uncertainty-list li::before {
            content: '‚ö†';
            position: absolute;
            left: 0;
            color: var(--warning);
        }

        /* Timeline */
        .timeline {
            margin-top: 2rem;
            position: relative;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }

        .timeline-item {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
        }

        .timeline-dot {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            z-index: 1;
            color: white;
            box-shadow: 0 2px 10px rgba(30, 58, 138, 0.3);
        }

        .timeline-content {
            background: var(--bg-light);
            padding: 1.5rem;
            border-radius: 12px;
            flex: 1;
            border: 1px solid var(--border);
        }

        .timeline-date {
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
        }

        /* Doctor Verification */
        .verification-panel {
            background: rgba(30, 58, 138, 0.05);
            border: 2px solid var(--primary);
            border-radius: 15px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .verification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .verification-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--primary);
            border-radius: 20px;
            font-weight: 600;
            color: white;
        }

        .doctor-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .doctor-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .doctor-details h4 {
            margin-bottom: 0.25rem;
        }

        .doctor-details p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* Loading Animation */
        .loading {
            display: none;
            text-align: center;
            padding: 3rem;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .upload-section {
                position: relative;
                top: 0;
            }

            .hero h1 {
                font-size: 2.5rem;
            }

            .stats {
                flex-direction: column;
                gap: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            nav {
                flex-wrap: wrap;
                justify-content: center;
            }

            .insights-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-light);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* File List Styles */
        .file-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-light);
            padding: 0.75rem;
            border-radius: 8px;
            margin-top: 0.5rem;
            border: 1px solid var(--border);
        }
        .file-list-item .file-name {
            font-size: 0.85rem;
            color: var(--text-primary);
            word-break: break-all;
            margin-right: 1rem;
        }
        .file-list-item .remove-file {
            color: var(--danger);
            cursor: pointer;
            font-size: 1.2rem;
            line-height: 1;
            padding: 0 0.5rem;
        }

        .analysis-section {
            margin-bottom: 1.5rem;
        }

        /* ===== GEMINI SUMMARY STYLES ===== */
        .summary-section {
            margin-bottom: 1.75rem;
        }
        .summary-section-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            letter-spacing: 0.02em;
            text-transform: uppercase;
        }
        .patient-card {
            background: linear-gradient(135deg, rgba(30,58,138,0.07), rgba(59,130,246,0.07));
            border-radius: 14px;
            padding: 1.25rem 1.5rem;
            border: 1px solid rgba(30,58,138,0.15);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
        }
        .patient-field {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }
        .patient-field-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        .patient-field-value {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .test-results-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 0.5rem;
        }
        .test-results-table thead th {
            font-size: 0.78rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0 1rem 0.25rem;
            text-align: left;
        }
        .test-row {
            background: var(--bg-light);
            border-radius: 10px;
            transition: all 0.2s;
        }
        .test-row:hover {
            background: var(--bg-card-hover);
            transform: translateX(4px);
        }
        .test-row td {
            padding: 0.85rem 1rem;
            font-size: 0.9rem;
        }
        .test-row td:first-child { border-radius: 10px 0 0 10px; }
        .test-row td:last-child { border-radius: 0 10px 10px 0; }
        .test-name { font-weight: 600; color: var(--text-primary); }
        .test-value { font-family: 'JetBrains Mono', monospace; font-weight: 700; }
        .test-value.val-normal { color: var(--accent); }
        .test-value.val-high { color: var(--danger); }
        .test-value.val-low { color: var(--warning); }
        .test-value.val-warning { color: var(--warning); }
        .test-range { color: var(--text-muted); font-size: 0.82rem; font-family: 'JetBrains Mono', monospace; }
        .test-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.25rem 0.65rem;
            border-radius: 20px;
            font-size: 0.78rem;
            font-weight: 700;
        }
        .badge-normal { background: rgba(16,185,129,0.15); color: var(--accent); }
        .badge-high { background: rgba(239,68,68,0.12); color: var(--danger); }
        .badge-low { background: rgba(245,158,11,0.15); color: var(--warning); }
        .badge-warning { background: rgba(245,158,11,0.15); color: var(--warning); }
        .test-description {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.2rem;
            line-height: 1.5;
        }
        .known-unclear-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .known-box, .unclear-box {
            border-radius: 12px;
            padding: 1.1rem 1.25rem;
        }
        .known-box {
            background: rgba(16,185,129,0.08);
            border: 1px solid rgba(16,185,129,0.2);
        }
        .unclear-box {
            background: rgba(245,158,11,0.08);
            border: 1px solid rgba(245,158,11,0.2);
        }
        .known-unclear-title {
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 0.6rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        .known-unclear-title.known { color: var(--accent); }
        .known-unclear-title.unclear { color: var(--warning); }
        .ku-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .ku-list li {
            font-size: 0.85rem;
            color: var(--text-secondary);
            padding: 0.3rem 0;
            display: flex;
            gap: 0.5rem;
            border-bottom: 1px solid rgba(0,0,0,0.04);
            line-height: 1.4;
        }
        .ku-list li:last-child { border-bottom: none; }
        .medicine-card {
            background: linear-gradient(135deg, rgba(59,130,246,0.07), rgba(30,58,138,0.05));
            border: 1px solid rgba(59,130,246,0.18);
            border-radius: 12px;
            padding: 1.1rem 1.25rem;
            margin-bottom: 0.6rem;
            display: flex;
            gap: 0.9rem;
            align-items: flex-start;
        }
        .medicine-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
            margin-top: 0.1rem;
        }
        .medicine-name {
            font-weight: 700;
            color: var(--primary);
            font-size: 0.95rem;
        }
        .medicine-insight {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.2rem;
            line-height: 1.5;
        }
        .confidence-meter {
            margin-top: 0.5rem;
        }
        .confidence-bar-wrap {
            background: var(--bg-light);
            border-radius: 20px;
            height: 10px;
            margin-top: 0.4rem;
            overflow: hidden;
        }
        .confidence-bar-fill {
            height: 100%;
            border-radius: 20px;
            background: linear-gradient(90deg, var(--primary-light), var(--accent));
            transition: width 1s ease;
        }
        .confidence-label-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.3rem;
            font-size: 0.82rem;
            color: var(--text-muted);
        }
        .disclaimer-box {
            background: rgba(245,158,11,0.07);
            border: 1px solid rgba(245,158,11,0.2);
            border-radius: 10px;
            padding: 0.85rem 1rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            gap: 0.5rem;
            align-items: flex-start;
            line-height: 1.5;
        }
        @media (max-width: 640px) {
            .known-unclear-grid { grid-template-columns: 1fr; }
            .patient-card { grid-template-columns: 1fr 1fr; }
        }

        /* ===== DEBUG / RAW JSON PANEL ===== */
        #debugPanel {
            display: none;
            margin-top: 1rem;
            background: #0f172a;
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid #1e293b;
        }
        #debugPanel h4 {
            color: #7dd3fc;
            font-size: 0.82rem;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        #debugJson {
            color: #86efac;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.78rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="background-animation"></div>

    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">+</div>
                    <span>Dr.MeD</span>
                </div>
                <nav>
                    <a href="#dashboard">Dashboard</a>
                    <a href="#reports">Reports</a>
                    <a href="#insights">Insights</a>
                    <a href="#doctors">Doctors</a>
                    <div class="user-profile">DR</div>
                </nav>
            </div>
        </div>
    </header>

    <div class="container">
        <section class="hero">
            <h1>Intelligent Medical Report Analysis</h1>
            <p>Transform complex medical reports into personalized, accurate, and easy-to-understand insights powered by advanced AI technology</p>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number">99.7%</div>
                    <div class="stat-label">Accuracy</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">2.3s</div>
                    <div class="stat-label">Avg. Analysis Time</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">50K+</div>
                    <div class="stat-label">Reports Analyzed</div>
                </div>
            </div>
        </section>

        <div class="main-content">
            <!-- Upload Section -->
            <aside class="upload-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 class="section-title" style="margin-bottom: 0;">
                        <span class="title-icon">üìÑ</span>
                        Upload Documents
                    </h2>
                    <div id="serverStatus" style="font-size: 0.75rem; padding: 0.35rem 0.8rem; border-radius: 20px; background: #f1f5f9; color: #64748b; display: flex; align-items: center; gap: 0.5rem; font-weight: 600; border: 1px solid #e2e8f0; transition: all 0.3s ease;">
                        <span style="width: 8px; height: 8px; background: #94a3b8; border-radius: 50%;"></span>
                        Checking...
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Lab Test Report</label>
                    <div class="upload-area" id="reportUploadArea" onclick="document.getElementById('reportInput').click()" style="padding: 1.5rem; min-height: auto;">
                        <div class="upload-content">
                            <div class="upload-icon" style="font-size: 2rem; margin-bottom: 0.5rem;">üß™</div>
                            <h3>Upload Report</h3>
                            <p style="color: var(--text-muted); font-size: 0.8rem;">Click to add pages</p>
                        </div>
                        <input type="file" id="reportInput" multiple style="display: none;" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                    <div id="reportFileList"></div>
                    <button class="analyze-btn" style="margin-top: 0.5rem; padding: 0.5rem; font-size: 0.9rem; background: transparent; border: 1px dashed var(--primary); color: var(--primary); box-shadow: none;" onclick="document.getElementById('reportInput').click()">+ Add Another Page</button>
                </div>

                <div class="patient-info">
                    <div class="form-group">
                        <label>Patient Name</label>
                        <input type="text" placeholder="Enter patient name" value="John Doe">
                    </div>
                    <div class="form-group">
                        <label>Age</label>
                        <input type="number" placeholder="Enter age" value="45">
                    </div>
                    <div class="form-group">
                        <label>Medical Condition</label>
                        <select>
                            <option>Diabetes</option>
                            <option>Hypertension</option>
                            <option>Heart Disease</option>
                            <option>Respiratory Issues</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Literacy Level</label>
                        <select>
                            <option>High (Medical Professional)</option>
                            <option selected>Medium (Educated Patient)</option>
                            <option>Low (Simple Terms)</option>
                        </select>
                    </div>
                    <button class="analyze-btn" onclick="analyzeReport()">
                        <span style="position: relative; z-index: 1;">üî¨ Analyze Report</span>
                    </button>
                </div>
            </aside>

            <!-- Results Section -->
            <main class="results-section">
                <!-- Loading State -->
                <div class="loading" id="loadingState">
                    <div class="spinner"></div>
                    <h3>Analyzing your medical report...</h3>
                    <p style="color: var(--text-muted); margin-top: 0.5rem;">This may take a few seconds</p>
                </div>

                <!-- AI Analysis -->
                <div class="card ai-analysis">
                    <div class="analysis-header">
                        <h2 class="section-title">
                            <span class="title-icon">ü§ñ</span>
                            AI-Powered Analysis
                        </h2>
                        <div class="confidence-badge" id="confidenceBadge" style="display:none;">
                            <span>‚úì</span>
                            <span id="confidenceText">-- Confidence</span>
                        </div>
                    </div>
                    <div class="analysis-content" id="analysisContent">
                        <!-- Default placeholder state -->
                        <div id="summaryPlaceholder" style="text-align:center; padding: 3rem 1rem; color: var(--text-muted);">
                            <div style="font-size: 3.5rem; margin-bottom: 1rem;">üî¨</div>
                            <h3 style="color: var(--text-secondary); font-size: 1.2rem; margin-bottom: 0.5rem;">No Report Analyzed Yet</h3>
                            <p style="font-size: 0.95rem;">Upload your medical report and fill in patient details, then click <strong style="color:var(--primary);">Analyze Report</strong> to see a full AI-powered summary here.</p>
                        </div>
                        <!-- Dynamic summary will be injected here -->
                        <div id="geminiSummary" style="display:none;"></div>
                        <!-- Raw JSON Debug Panel -->
                        <div style="margin-top:0.75rem;text-align:right;">
                            <button onclick="toggleDebug()" id="debugToggleBtn" style="display:none;background:transparent;border:1px solid #334155;border-radius:6px;padding:0.3rem 0.75rem;font-size:0.75rem;color:#64748b;cursor:pointer;">
                                üõ† Show Raw JSON
                            </button>
                        </div>
                        <div id="debugPanel">
                            <h4>üõ† Raw JSON Response from Backend</h4>
                            <pre id="debugJson"></pre>
                        </div>
                    </div>
                </div>

                <!-- Medical Insights -->
                <div class="card">
                    <h2 class="section-title">
                        <span class="title-icon">üí°</span>
                        Personalized Insights
                    </h2>
                    <div class="insights-grid">
                        <div class="insight-card">
                            <div class="insight-icon">üìä</div>
                            <div class="insight-title">Trend Analysis</div>
                            <div class="insight-description">Your glucose control has improved by 18% over the past 3 months</div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-icon">üéØ</div>
                            <div class="insight-title">Risk Assessment</div>
                            <div class="insight-description">Low risk for cardiovascular complications with current management</div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-icon">üî¨</div>
                            <div class="insight-title">Lab Comparison</div>
                            <div class="insight-description">Results align with age-appropriate reference ranges</div>
                        </div>
                        <div class="insight-card">
                            <div class="insight-icon">‚è±Ô∏è</div>
                            <div class="insight-title">Next Steps</div>
                            <div class="insight-description">Follow-up testing recommended in 12 weeks</div>
                        </div>
                    </div>
                </div>

                <!-- Recommendations -->
                <div class="card">
                    <h2 class="section-title">
                        <span class="title-icon">üíä</span>
                        AI Recommendations
                    </h2>
                    <div class="recommendations">
                        <div class="recommendation-item">
                            <div class="recommendation-icon">ü•ó</div>
                            <div class="recommendation-content">
                                <h4>Dietary Adjustments</h4>
                                <p>Consider increasing fiber intake and reducing saturated fats to help manage cholesterol levels. Focus on omega-3 rich foods like salmon, walnuts, and flaxseeds.</p>
                            </div>
                        </div>
                        <div class="recommendation-item">
                            <div class="recommendation-icon">üèÉ</div>
                            <div class="recommendation-content">
                                <h4>Physical Activity</h4>
                                <p>Maintain current exercise routine of 30 minutes daily. Consider adding 2 days of resistance training per week to improve metabolic health.</p>
                            </div>
                        </div>
                        <div class="recommendation-item">
                            <div class="recommendation-icon">üíä</div>
                            <div class="recommendation-content">
                                <h4>Medication Review</h4>
                                <p>Current diabetes medication appears effective. Discuss cholesterol management options with your doctor during next visit.</p>
                            </div>
                        </div>
                        <div class="recommendation-item">
                            <div class="recommendation-icon">üìÖ</div>
                            <div class="recommendation-content">
                                <h4>Monitoring Schedule</h4>
                                <p>Schedule follow-up blood work in 12 weeks. Continue daily glucose monitoring and weekly blood pressure checks at home.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="card">
                    <h2 class="section-title">
                        <span class="title-icon">üìà</span>
                        Health Timeline
                    </h2>
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-dot">1</div>
                            <div class="timeline-content">
                                <div class="timeline-date">3 Months Ago</div>
                                <h4>Initial Diagnosis</h4>
                                <p style="color: var(--text-secondary);">HbA1c: 7.8% - Started medication and lifestyle modifications</p>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-dot">2</div>
                            <div class="timeline-content">
                                <div class="timeline-date">6 Weeks Ago</div>
                                <h4>Progress Check</h4>
                                <p style="color: var(--text-secondary);">HbA1c: 6.9% - Showing improvement, continued current treatment</p>
                            </div>
                        </div>
                        <div class="timeline-item">
                            <div class="timeline-dot">3</div>
                            <div class="timeline-content">
                                <div class="timeline-date">Today</div>
                                <h4>Current Status</h4>
                                <p style="color: var(--text-secondary);">HbA1c: 6.2% - Excellent progress! Within target range</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Doctor Verification -->
                <div class="verification-panel">
                    <div class="verification-header">
                        <h2 class="section-title">
                            <span class="title-icon">üë®‚Äç‚öïÔ∏è</span>
                            Doctor Verification
                        </h2>
                        <div class="verification-status">
                            <span>‚úì</span>
                            <span>Verified by Specialist</span>
                        </div>
                    </div>
                    <div class="doctor-info">
                        <div class="doctor-avatar">üë®‚Äç‚öïÔ∏è</div>
                        <div class="doctor-details">
                            <h4>Dr. Sarah Johnson, MD</h4>
                            <p>Endocrinologist ‚Ä¢ 15 years experience</p>
                            <p style="margin-top: 0.5rem; color: var(--text-secondary);">
                                "This AI analysis is accurate and comprehensive. I've reviewed the findings and recommendations, which align with current clinical guidelines. Continue your current management plan and schedule follow-up as suggested."
                            </p>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-light); border-radius: 10px; border: 1px solid var(--border);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-secondary);">Verification Date:</span>
                            <span style="color: var(--text-primary); font-weight: 600;">Feb 17, 2026 - 2:45 PM</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">License No:</span>
                            <span style="color: var(--text-primary); font-weight: 600;">MD-456789</span>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // ==================== API CONFIGURATION ====================
        // BASE_URL uses a RELATIVE path ('/api') so it works automatically
        // no matter what backend language, port, or server you use.
        //
        // This works because Flask now SERVES this HTML file directly at
        // http://localhost:5001 ‚Äî so the page and the API share the same
        // origin. No CORS headers are ever needed.
        //
        // Rule: always open the app via  http://localhost:5001
        //       NOT by double-clicking the file (file:// breaks fetch).
        const API_CONFIG = {
            BASE_URL: '/api',           // ‚Üê relative: works on any host/port
            ENDPOINTS: {
                UPLOAD_REPORT: '/upload-report',
                ANALYZE_REPORT: '/analyze',
                GET_PATIENT_HISTORY: '/patient/history',
                VERIFY_DOCTOR: '/doctor/verify',
                GET_RECOMMENDATIONS: '/recommendations',
                SAVE_ANALYSIS: '/analysis/save'
            },
            HEADERS: {
                'Content-Type': 'application/json'
            }
        };

        // ==================== AI MODEL ENDPOINTS ====================
        // Configure your trained model endpoints
        const MODEL_ENDPOINTS = {
            // Medical NLP Model - for report text extraction and understanding
            NLP_MODEL: API_CONFIG.BASE_URL + '/models/nlp/extract',
            
            // Classification Model - for disease/condition classification
            CLASSIFIER_MODEL: API_CONFIG.BASE_URL + '/models/classify',
            
            // Risk Assessment Model - for predicting health risks
            RISK_MODEL: API_CONFIG.BASE_URL + '/models/risk-assessment',
            
            // RAG System - Retrieval Augmented Generation for medical context
            RAG_ENDPOINT: API_CONFIG.BASE_URL + '/rag/query',
            
            // Personalization Model - age/condition based customization
            PERSONALIZATION: API_CONFIG.BASE_URL + '/models/personalize',
            
            // Confidence Scoring - hallucination detection
            CONFIDENCE_SCORER: API_CONFIG.BASE_URL + '/models/confidence'
        };

        // ==================== UTILITY FUNCTIONS ====================
        /**
         * Make API calls to backend
         * @param {string} endpoint - API endpoint URL
         * @param {string} method - HTTP method (GET, POST, etc.)
         * @param {object} data - Request payload
         * @returns {Promise} API response
         */
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: API_CONFIG.HEADERS
                };

                if (data && method !== 'GET') {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(endpoint, options);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Call Error:', error);
                // For demo purposes, return mock data if API fails
                return getMockData(endpoint);
            }
        }

        /**
         * Upload medical report file to backend
         * @param {Array} reportFiles - Array of medical report files
         * @param {object} patientData - Patient information
         * @returns {Promise} Upload response with file ID
         */
        async function uploadMedicalReport(reportFiles, patientData) {
            const formData = new FormData();
            reportFiles.forEach(file => formData.append('report', file));
            formData.append('patientData', JSON.stringify(patientData));

            try {
                const response = await fetch(
                    API_CONFIG.BASE_URL + API_CONFIG.ENDPOINTS.UPLOAD_REPORT,
                    {
                        method: 'POST',
                        body: formData,
                        // Remove Content-Type header for FormData
                        headers: {
                            'Authorization': API_CONFIG.HEADERS.Authorization || ''
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error('Upload failed');
                }

                return await response.json();
            } catch (error) {
                console.error('Upload Error:', error);
                // Return mock response for demo
                return {
                    success: true,
                    fileId: 'demo_' + Date.now(),
                    message: 'File uploaded successfully (Demo Mode)'
                };
            }
        }

        /**
         * Analyze medical report using AI models
         * @param {string} fileId - Uploaded file ID
         * @param {object} patientContext - Patient context for personalization
         * @returns {Promise} Analysis results
         */
        async function analyzeMedicalReport(fileId, patientContext) {
            const analysisPayload = {
                fileId: fileId,
                patientContext: patientContext,
                models: {
                    nlp: true,
                    classifier: true,
                    risk: true,
                    rag: true,
                    personalization: true,
                    confidence: true
                }
            };

            try {
                const response = await apiCall(
                    API_CONFIG.BASE_URL + API_CONFIG.ENDPOINTS.ANALYZE_REPORT,
                    'POST',
                    analysisPayload
                );

                return response;
            } catch (error) {
                console.error('Analysis Error:', error);
                return getMockAnalysisData();
            }
        }

        /**
         * Mock data for demo/testing when backend is not available
         */
        function getMockData(endpoint) {
            console.warn('Using mock data - Backend not connected');
            return {
                success: true,
                demo: true,
                message: 'Backend not connected - showing demo data'
            };
        }

        function getMockAnalysisData() {
            return {
                success: true,
                confidence: 96,
                findings: [
                    { label: 'Blood Glucose (Fasting)', value: '105 mg/dL', status: 'normal' },
                    { label: 'HbA1c', value: '6.2%', status: 'normal' },
                    { label: 'Total Cholesterol', value: '215 mg/dL', status: 'warning' },
                    { label: 'Blood Pressure', value: '120/80 mmHg', status: 'normal' },
                    { label: 'Kidney Function (eGFR)', value: '95 mL/min', status: 'normal' }
                ],
                analysis: "Based on your comprehensive blood work analysis, your overall health indicators show positive trends. Your glucose levels have improved significantly since the last test, indicating good diabetes management through medication and lifestyle changes. However, we've noticed a slight elevation in cholesterol levels that requires monitoring.",
                recommendations: [
                    {
                        title: "Dietary Adjustments",
                        description: "Consider increasing fiber intake and reducing saturated fats to help manage cholesterol levels.",
                        icon: "ü•ó"
                    },
                    {
                        title: "Physical Activity",
                        description: "Maintain current exercise routine of 30 minutes daily.",
                        icon: "üèÉ"
                    },
                    {
                        title: "Medication Review",
                        description: "Current diabetes medication appears effective. Discuss cholesterol management with your doctor.",
                        icon: "üíä"
                    }
                ],
                uncertainties: [
                    'Slight elevation in LDL cholesterol - recommend lipid panel retest in 3 months',
                    'Vitamin D levels not included in current report',
                    'Liver enzyme values borderline - follow-up recommended'
                ]
            };
        }

        // ==================== EVENT HANDLERS ====================
        
        // Global state for files
        let reportFiles = [];

        // File upload handler helper
        function setupFileUpload(inputId, listId, fileArray, type) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            
            input.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    // Add new files to array
                    Array.from(e.target.files).forEach(file => {
                        fileArray.push(file);
                    });
                    renderFileList(list, fileArray, type);
                    // Reset input
                    input.value = '';
                }
            });
        }

        function renderFileList(container, fileArray, type) {
            container.innerHTML = fileArray.map((file, index) => `
                <div class="file-list-item">
                    <span class="file-name">üìÑ ${file.name}</span>
                    <span class="remove-file" onclick="removeFile('${type}', ${index})">√ó</span>
                </div>
            `).join('');
        }

        function removeFile(type, index) {
            if (type === 'report') {
                reportFiles.splice(index, 1);
                renderFileList(document.getElementById('reportFileList'), reportFiles, 'report');
            }
        }

        setupFileUpload('reportInput', 'reportFileList', reportFiles, 'report');

        // ==================== HELPERS ====================
        function escH(str) {
            return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        function getStatusIcon(status) {
            return { 'normal':'‚úì', 'warning':'‚ö†', 'critical':'‚ö†', 'excellent':'‚úì', 'low':'‚Üì', 'high':'‚Üë' }[status] || '';
        }

        // ==================== BUILD SUMMARY HTML ====================
        // Maps the backend /api/analyze response shape to the summary card.
        // Backend returns:
        //   { success, analysisId, confidence (int 0-100), aiResponse, findings[], recommendations[], uncertainties[] }
        // aiResponse: { patient_summary, test_report_summary, clinical_interpretation, known_information[], unclear_information[] }
        // findings[]:  { label, value, status (lowercase), normalRange }
        // recommendations[]: { title, description, icon }

        function buildSummaryHTML(results, patientData) {
            console.log("üîç buildSummaryHTML raw input:", JSON.stringify(results, null, 2));

            // ‚îÄ‚îÄ Normalize: handle nested result object ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const data = results.result || results;

            // ‚îÄ‚îÄ Normalize aiResponse ‚Äî handle string, object, or missing ‚îÄ‚îÄ‚îÄ
            let ai = data.aiResponse || data.ai_response || data.llm_result || {};

            if (typeof ai === 'string') {
                try {
                    const clean = ai.replace(/```json\n?|```/g, '').trim();
                    ai = clean.startsWith('{') ? JSON.parse(clean) : { test_report_summary: ai };
                } catch(e) {
                    ai = { test_report_summary: ai };
                }
            }

            // ‚îÄ‚îÄ Also check if LLM fields were returned at the TOP LEVEL ‚îÄ‚îÄ‚îÄ‚îÄ
            // (some backends flatten the response)
            if (!ai.patient_summary && data.patient_summary) ai.patient_summary = data.patient_summary;
            if (!ai.test_report_summary && data.test_report_summary) ai.test_report_summary = data.test_report_summary;
            if (!ai.clinical_interpretation && data.clinical_interpretation) ai.clinical_interpretation = data.clinical_interpretation;
            if (!ai.known_information && data.known_information) ai.known_information = data.known_information;
            if (!ai.unclear_information && data.unclear_information) ai.unclear_information = data.unclear_information;

            console.log("üîç Normalized ai object:", ai);

            const findings  = Array.isArray(data.findings) ? data.findings : [];
            const recs      = Array.isArray(data.recommendations) ? data.recommendations : [];
            const known     = Array.isArray(ai.known_information) ? ai.known_information : [];
            const unclear   = Array.isArray(ai.unclear_information) ? ai.unclear_information : (Array.isArray(data.uncertainties) ? data.uncertainties : []);
            const conf      = parseInt(data.confidence) || 80;
            const confColor = conf >= 85 ? 'var(--accent)' : conf >= 65 ? 'var(--warning)' : 'var(--danger)';

            const reportSummaryText = ai.test_report_summary || ai.report_summary || data.analysis || '';
            const hasContent = !!(ai.patient_summary || reportSummaryText || ai.clinical_interpretation);

            // 1 ‚Äî Patient info block
            const patientHTML = `
            <div class="summary-section">
                <div class="summary-section-title">üë§ Patient Information</div>
                <div class="patient-card">
                    <div class="patient-field"><span class="patient-field-label">Name</span><span class="patient-field-value">${escH(patientData.name)}</span></div>
                    <div class="patient-field"><span class="patient-field-label">Age</span><span class="patient-field-value">${escH(patientData.age)} yrs</span></div>
                    <div class="patient-field"><span class="patient-field-label">Condition</span><span class="patient-field-value">${escH(patientData.condition)}</span></div>
                    <div class="patient-field"><span class="patient-field-label">Date</span><span class="patient-field-value">${escH(patientData.date)}</span></div>
                    ${data.analysisId ? `<div class="patient-field"><span class="patient-field-label">Analysis ID</span><span class="patient-field-value" style="font-size:0.8rem;">${escH(data.analysisId)}</span></div>` : ''}
                </div>
            </div>`;

            // 2 ‚Äî Clinical summary (from LLM)
            const summaryHTML = hasContent ? `
            <div class="summary-section">
                <div class="summary-section-title">üè• Clinical Summary</div>
                ${ai.patient_summary ? `<p style="font-size:0.92rem;color:var(--text-secondary);margin-bottom:0.75rem;line-height:1.7;"><strong>Patient Summary:</strong> ${escH(ai.patient_summary)}</p>` : ''}
                ${reportSummaryText ? `<p style="font-size:0.92rem;color:var(--text-secondary);margin-bottom:0.75rem;line-height:1.7;"><strong>Report Summary:</strong> ${escH(reportSummaryText)}</p>` : ''}
                ${ai.clinical_interpretation ? `
                <div style="background:rgba(59,130,246,0.06);border-left:4px solid var(--primary);padding:1rem 1.25rem;border-radius:0 12px 12px 0;margin-top:0.25rem;">
                    <p style="font-size:0.93rem;color:var(--text-secondary);line-height:1.75;"><strong>Clinical Interpretation:</strong> ${escH(ai.clinical_interpretation)}</p>
                    <div style="font-size:0.73rem;color:var(--text-muted);margin-top:0.5rem;">üõ°Ô∏è Generated using verified medical guideline retrieval (RAG)</div>
                </div>` : ''}
            </div>` : `
            <div class="summary-section">
                <div class="summary-section-title">üè• Report Analysis</div>
                <p style="font-size:0.92rem;color:var(--text-secondary);line-height:1.7;">
                    ${escH(data.analysis || 'Analysis completed. No summary text was returned ‚Äî please check the raw JSON panel below for the full backend response.')}
                </p>
            </div>`;

            // 3 ‚Äî Test results table
            const testsHTML = findings.length > 0 ? `
            <div class="summary-section">
                <div class="summary-section-title">üìä Test Results</div>
                <table class="test-results-table">
                    <thead><tr><th>Test</th><th>Value</th><th>Normal Range</th><th>Status</th></tr></thead>
                    <tbody>
                        ${findings.map(f => {
                            const st = (f.status || 'normal').toLowerCase();
                            const valClass = st === 'normal' ? 'val-normal' : st === 'high' ? 'val-high' : st === 'low' ? 'val-low' : 'val-warning';
                            const badgeClass = st === 'normal' ? 'badge-normal' : st === 'high' ? 'badge-high' : st === 'low' ? 'badge-low' : 'badge-warning';
                            const icon = st === 'normal' ? '‚úì' : st === 'high' ? '‚Üë' : st === 'low' ? '‚Üì' : '‚ö†';
                            return `<tr class="test-row">
                                <td><div class="test-name">${escH(f.label || f.test || '')}</div></td>
                                <td><span class="test-value ${valClass}">${escH(String(f.value || ''))} ${icon}</span></td>
                                <td><span class="test-range">${escH(f.normalRange || f.range || '‚Äî')}</span></td>
                                <td><span class="test-status-badge ${badgeClass}">${icon} ${escH(st.charAt(0).toUpperCase() + st.slice(1))}</span></td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
            </div>` : '';

            // 4 ‚Äî AI recommendations / medicines
            const medsHTML = recs.length > 0 ? `
            <div class="summary-section">
                <div class="summary-section-title">üíä AI Recommendations</div>
                ${recs.map(r => `
                <div class="medicine-card">
                    <div class="medicine-icon">${escH(r.icon || 'üíä')}</div>
                    <div>
                        <div class="medicine-name">${escH(r.title || '')}</div>
                        <div class="medicine-insight">${escH(r.description || '')}</div>
                    </div>
                </div>`).join('')}
                <div class="disclaimer-box"><span>‚ö†Ô∏è</span><span>AI-generated suggestions only. Always consult a licensed physician before making any changes to your treatment plan.</span></div>
            </div>` : '';

            // 5 ‚Äî Known vs Unclear
            const kuHTML = `
            <div class="summary-section">
                <div class="summary-section-title">üîç Known vs Unclear</div>
                <div class="known-unclear-grid">
                    <div class="known-box">
                        <div class="known-unclear-title known">‚úÖ Known Information</div>
                        <ul class="ku-list">${known.length > 0 ? known.map(k=>`<li><span>‚Ä¢</span>${escH(k)}</li>`).join('') : '<li><span>‚Ä¢</span>No specific items extracted.</li>'}</ul>
                    </div>
                    <div class="unclear-box">
                        <div class="known-unclear-title unclear">‚ùì Unclear / Missing</div>
                        <ul class="ku-list">${unclear.length > 0 ? unclear.map(u=>`<li><span>‚Ä¢</span>${escH(u)}</li>`).join('') : '<li><span>‚Ä¢</span>No gaps identified.</li>'}</ul>
                    </div>
                </div>
            </div>`;

            // 6 ‚Äî Confidence meter
            const confHTML = `
            <div class="summary-section">
                <div class="summary-section-title">üìà Analysis Confidence</div>
                <div class="confidence-meter">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                        <span style="font-size:0.9rem;color:var(--text-secondary);">Report analysis confidence score</span>
                        <span style="font-size:1.4rem;font-weight:800;color:${confColor};font-family:'JetBrains Mono',monospace;">${conf}%</span>
                    </div>
                    <div class="confidence-bar-wrap"><div class="confidence-bar-fill" id="confBarFill" style="width:0%;"></div></div>
                    <div class="confidence-label-row"><span>Low</span><span>High</span></div>
                    <p style="font-size:0.8rem;color:var(--text-muted);margin-top:0.4rem;">
                        ${conf >= 85 ? '‚úÖ High confidence ‚Äî LLM analysis succeeded with strong data extraction.' : conf >= 65 ? '‚ö†Ô∏è Moderate confidence ‚Äî some data may be incomplete.' : '‚ö†Ô∏è Low confidence ‚Äî fallback mode or limited data.'}
                    </p>
                </div>
            </div>`;

            setTimeout(() => {
                const bar = document.getElementById('confBarFill');
                if (bar) bar.style.cssText = `width:${conf}%;background:linear-gradient(90deg,${confColor},${confColor}88);transition:width 1s ease;`;
            }, 150);

            return patientHTML + summaryHTML + testsHTML + medsHTML + kuHTML + confHTML;
        }

        function showRawJSON(data) {
            const panel = document.getElementById('debugPanel');
            const pre   = document.getElementById('debugJson');
            const btn   = document.getElementById('debugToggleBtn');
            pre.textContent = JSON.stringify(data, null, 2);
            // Keep panel hidden by default but show the toggle button
            panel.style.display = 'none';
            if (btn) btn.style.display = 'inline-block';
        }

        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            const btn   = document.getElementById('debugToggleBtn');
            const visible = panel.style.display !== 'none';
            panel.style.display = visible ? 'none' : 'block';
            if (btn) btn.textContent = visible ? 'üõ† Show Raw JSON' : 'üõ† Hide Raw JSON';
        }

        // ==================== ANALYZE REPORT (BACKEND-DRIVEN) ====================
        // Calls Flask backend: POST /api/upload-report ‚Üí POST /api/analyze
        // Matches exactly the endpoints and response shape in backend_server.py

        async function analyzeReport() {
            const loadingState = document.getElementById('loadingState');
            const resultsSection = document.querySelector('.results-section');
            const summaryPlaceholder = document.getElementById('summaryPlaceholder');
            const geminiSummary = document.getElementById('geminiSummary');
            const confidenceBadge = document.getElementById('confidenceBadge');
            const confidenceText = document.getElementById('confidenceText');

            const patientData = {
                name: document.querySelector('input[type="text"]').value || 'Unknown',
                age: document.querySelector('input[type="number"]').value || 'N/A',
                condition: document.querySelector('select').value,
                literacyLevel: document.querySelectorAll('select')[1].value,
                date: new Date().toLocaleDateString()
            };

            if (reportFiles.length === 0) {
                alert('Please upload at least one medical report (PDF, JPG, or PNG) before analyzing.');
                return;
            }

            // ‚îÄ‚îÄ Helper: fetch with timeout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            async function fetchWithTimeout(url, options = {}, timeoutMs = 60000) {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeoutMs);
                try {
                    const res = await fetch(url, { ...options, signal: controller.signal });
                    clearTimeout(id);
                    return res;
                } catch (e) {
                    clearTimeout(id);
                    if (e.name === 'AbortError') throw new Error('Request timed out after ' + timeoutMs/1000 + 's');
                    // Provide a clearer CORS/network error message
                    if (e.message === 'Failed to fetch' || e.message.includes('NetworkError') || e.message.includes('CORS')) {
                        throw new Error(
                            'Cannot connect to backend. ' +
                            'SOLUTION: Run the backend ‚Üí python backend_server.py ' +
                            'then open http://localhost:5001 in your browser. ' +
                            'Do NOT open medical-ai.html by double-clicking it.'
                        );
                    }
                    throw e;
                }
            }

            // Show loading, dim other cards
            loadingState.classList.add('active');
            summaryPlaceholder.style.display = 'none';
            geminiSummary.style.display = 'none';
            confidenceBadge.style.display = 'none';
            const otherCards = resultsSection.querySelectorAll('.card:not(.ai-analysis), .verification-panel');
            otherCards.forEach(c => { c.style.opacity = '0.4'; c.style.pointerEvents = 'none'; });

            const showError = (msg) => {
                loadingState.classList.remove('active');
                otherCards.forEach(c => { c.style.opacity = '1'; c.style.pointerEvents = 'auto'; });
                summaryPlaceholder.style.display = 'none';
                geminiSummary.innerHTML = `
                    <div style="padding:2rem 1.5rem;">
                        <div style="font-size:2.5rem;margin-bottom:1rem;text-align:center;">‚ö†Ô∏è</div>
                        <h3 style="color:var(--danger);margin-bottom:0.75rem;text-align:center;">Analysis Failed</h3>
                        <p style="color:var(--text-secondary);font-size:0.92rem;line-height:1.7;margin-bottom:1rem;">${escH(msg)}</p>
                        <div style="padding:1rem;background:var(--bg-light);border-radius:10px;border:1px solid var(--border);font-size:0.82rem;color:var(--text-muted);line-height:1.8;">
                            <strong>‚úÖ Quick Fix Checklist:</strong><br>
                            1. Start the backend: <code style="background:#e2e8f0;padding:0.1rem 0.4rem;border-radius:4px;">python backend_server.py</code><br>
                            2. Open the app at: <code style="background:#e2e8f0;padding:0.1rem 0.4rem;border-radius:4px;">http://localhost:5001</code><br>
                            &nbsp;&nbsp;&nbsp;‚ö†Ô∏è Do NOT open medical-ai.html by double-clicking ‚Äî always use the URL above<br>
                            3. Allowed file types: PDF, PNG, JPG, JPEG (max 10MB)
                        </div>
                    </div>`;
                geminiSummary.style.display = 'block';
            };

            try {
                // ‚îÄ‚îÄ Step 1: Check backend health ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                let backendOK = false;
                try {
                    const healthRes = await fetchWithTimeout(API_CONFIG.BASE_URL + '/health', { method: 'GET' }, 10000);
                    backendOK = healthRes.ok;
                } catch(e) {
                    throw new Error(e.message || ('Cannot reach backend at ' + API_CONFIG.BASE_URL + '. Make sure Flask server is running on port 5001.'));
                }

                if (!backendOK) {
                    throw new Error('Backend health check failed at ' + API_CONFIG.BASE_URL + '/health. Make sure Flask server is running.');
                }

                // ‚îÄ‚îÄ Step 2: Upload files ‚Üí POST /api/upload-report ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const formData = new FormData();
                reportFiles.forEach(file => formData.append('report', file));
                formData.append('patientData', JSON.stringify(patientData));

                const uploadRes = await fetchWithTimeout(
                    API_CONFIG.BASE_URL + API_CONFIG.ENDPOINTS.UPLOAD_REPORT,
                    { method: 'POST', body: formData },
                    30000
                );

                if (!uploadRes.ok) {
                    const err = await uploadRes.json().catch(() => ({}));
                    throw new Error('Upload failed (' + uploadRes.status + '): ' + (err.error || uploadRes.statusText));
                }

                const uploadData = await uploadRes.json();
                if (!uploadData.success || !uploadData.fileId) {
                    throw new Error('Upload response invalid: ' + JSON.stringify(uploadData));
                }
                const fileId = uploadData.fileId;
                console.log('‚úÖ Upload success. File ID:', fileId);

                // ‚îÄ‚îÄ Step 3: Analyze ‚Üí POST /api/analyze ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const analyzePayload = {
                    fileId: fileId,
                    patientContext: patientData,
                    models: { nlp: true, classifier: true, risk: true, rag: true, personalization: true, confidence: true }
                };

                const analyzeRes = await fetchWithTimeout(
                    API_CONFIG.BASE_URL + API_CONFIG.ENDPOINTS.ANALYZE_REPORT,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(analyzePayload)
                    },
                    120000  // 2 min timeout ‚Äî LLM can be slow
                );

                if (!analyzeRes.ok) {
                    const err = await analyzeRes.json().catch(() => ({}));
                    throw new Error('Analysis failed (' + analyzeRes.status + '): ' + (err.error || analyzeRes.statusText));
                }

                const analysisData = await analyzeRes.json();
                if (!analysisData.success) {
                    throw new Error('Analysis error: ' + (analysisData.error || 'Unknown error from server'));
                }
                console.log('‚úÖ Analysis complete:', analysisData);

                // ‚îÄ‚îÄ Show raw JSON for debugging ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                showRawJSON(analysisData);

                // ‚îÄ‚îÄ Step 4: Render summary ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                const resultData = analysisData.result || analysisData;
                const conf = parseInt(resultData.confidence) || 80;
                confidenceText.textContent = conf + '% Confidence';
                confidenceBadge.style.display = 'flex';

                // Inject the full summary HTML into the page
                geminiSummary.innerHTML = buildSummaryHTML(analysisData, patientData);
                geminiSummary.style.display = 'block';

                // ‚îÄ‚îÄ Step 5: Update Recommendations card ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                if (resultData.recommendations && resultData.recommendations.length > 0) {
                    const recContainer = document.querySelector('.recommendations');
                    if (recContainer) {
                        recContainer.innerHTML = resultData.recommendations.map(rec => `
                            <div class="recommendation-item">
                                <div class="recommendation-icon">${escH(rec.icon || 'üí°')}</div>
                                <div class="recommendation-content">
                                    <h4>${escH(rec.title || '')}</h4>
                                    <p>${escH(rec.description || '')}</p>
                                </div>
                            </div>`).join('');
                    }
                }

                loadingState.classList.remove('active');
                otherCards.forEach(c => { c.style.opacity = '1'; c.style.pointerEvents = 'auto'; });

                // Scroll to the AI analysis card smoothly
                setTimeout(() => {
                    document.querySelector('.ai-analysis').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);

            } catch (error) {
                console.error('‚ùå Analysis error:', error);
                showError(error.message);
            }
        }

        // Smooth scroll for navigation
        document.querySelectorAll('nav a').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href'))?.scrollIntoView({
                    behavior: 'smooth'
                });
            });
        });

        // Add interactive hover effects
        document.querySelectorAll('.card').forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-8px)';
            });
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });

        // Animate stats on scroll
        const observerOptions = {
            threshold: 0.5
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    animateValue(entry.target);
                }
            });
        }, observerOptions);

        document.querySelectorAll('.stat-number').forEach(stat => observer.observe(stat));

        function animateValue(element) {
            const text = element.textContent;
            const isPercentage = text.includes('%');
            const hasDecimal = text.includes('.');
            const hasSuffix = text.includes('K') || text.includes('s');
            
            let finalValue = parseFloat(text);
            let current = 0;
            const increment = finalValue / 50;
            
            const timer = setInterval(() => {
                current += increment;
                if (current >= finalValue) {
                    current = finalValue;
                    clearInterval(timer);
                }
                
                let displayValue = hasDecimal ? current.toFixed(1) : Math.floor(current);
                if (isPercentage) displayValue += '%';
                if (text.includes('K')) displayValue = Math.floor(current) + 'K+';
                if (text.includes('s')) displayValue = current.toFixed(1) + 's';
                
                element.textContent = displayValue;
            }, 30);
        }

        // ==================== SERVER STATUS INDICATOR ====================
        function updateServerStatus(isOnline) {
            const statusEl = document.getElementById('serverStatus');
            if (!statusEl) return;
            
            if (isOnline) {
                statusEl.style.background = 'rgba(16, 185, 129, 0.1)';
                statusEl.style.color = 'var(--accent)';
                statusEl.style.borderColor = 'rgba(16, 185, 129, 0.2)';
                statusEl.innerHTML = '<span style="width: 8px; height: 8px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);"></span> Online';
            } else {
                statusEl.style.background = 'rgba(239, 68, 68, 0.1)';
                statusEl.style.color = 'var(--danger)';
                statusEl.style.borderColor = 'rgba(239, 68, 68, 0.2)';
                statusEl.innerHTML = '<span style="width: 8px; height: 8px; background: var(--danger); border-radius: 50%; box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);"></span> Offline';
            }
        }

        async function checkServerHealth() {
            try {
                // Check if running on VS Code Live Server (55xx) or 5000 - Auto Redirect to 5001
                const port = window.location.port;
                if (port === '5000' || (port && port.startsWith('55'))) {
                    window.location.href = 'http://localhost:5001';
                    return;
                }

                // Check if running on file://
                if (window.location.protocol === 'file:') {
                    const msg = "‚ö†Ô∏è WRONG PROTOCOL: You are opening the file directly. Please run 'python backend_server.py' and open http://localhost:5001";
                    console.error(msg);
                    document.getElementById('serverStatus').innerHTML = '<span style="color:var(--danger)">‚ùå Open via http://localhost:5001</span>';
                }

                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), 2000);
                const res = await fetch(API_CONFIG.BASE_URL + '/health', { signal: controller.signal });
                clearTimeout(id);
                updateServerStatus(res.ok);
            } catch (e) {
                updateServerStatus(false);
            }
        }

        // Check on load and every 5 seconds
        checkServerHealth();
        setInterval(checkServerHealth, 5000);
    </script>
</body>
</html>